{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "web2fb Configuration",
  "description": "Configuration schema for web2fb - Web to Framebuffer Renderer",
  "type": "object",
  "required": ["display"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Human-readable name for this configuration"
    },
    "description": {
      "type": "string",
      "description": "Description of what this configuration does"
    },
    "display": {
      "type": "object",
      "required": ["url"],
      "properties": {
        "url": {
          "type": "string",
          "description": "URL of the webpage to render",
          "format": "uri"
        },
        "width": {
          "type": "integer",
          "description": "Display width in pixels",
          "default": 1920,
          "minimum": 1
        },
        "height": {
          "type": "integer",
          "description": "Display height in pixels",
          "default": 1080,
          "minimum": 1
        },
        "framebufferDevice": {
          "type": "string",
          "description": "Path to framebuffer device",
          "default": "/dev/fb0"
        }
      }
    },
    "browser": {
      "type": "object",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["local", "remote"],
          "description": "Screenshot mode: 'local' uses Puppeteer on Pi, 'remote' uses cloud service (Cloudflare Worker)",
          "default": "local"
        },
        "remoteScreenshotUrl": {
          "type": "string",
          "description": "URL to remote screenshot service (Cloudflare Worker). Required when mode is 'remote'",
          "format": "uri"
        },
        "remoteApiKey": {
          "type": "string",
          "description": "API key for authenticating with remote screenshot service"
        },
        "remoteTimeout": {
          "type": "integer",
          "description": "Timeout for remote screenshot requests in milliseconds",
          "default": 60000,
          "minimum": 5000
        },
        "userAgent": {
          "type": "string",
          "description": "Custom user agent string"
        },
        "timeout": {
          "type": "integer",
          "description": "Page navigation timeout in milliseconds (local browser only)",
          "default": 180000,
          "minimum": 1000
        },
        "imageLoadTimeout": {
          "type": "integer",
          "description": "Image loading timeout in milliseconds",
          "default": 120000,
          "minimum": 1000
        },
        "disableAnimations": {
          "type": "boolean",
          "description": "Disable CSS animations and transitions (local browser only)",
          "default": true
        }
      }
    },
    "overlays": {
      "type": "array",
      "description": "Elements to hide and re-render locally for performance",
      "items": {
        "type": "object",
        "required": ["name", "type", "selector", "region", "detectedStyle"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Unique identifier for this overlay"
          },
          "type": {
            "type": "string",
            "enum": ["clock", "date", "text", "custom"],
            "description": "Type of overlay renderer to use"
          },
          "selector": {
            "type": "string",
            "description": "CSS selector to find the element to replace"
          },
          "enabled": {
            "type": "boolean",
            "description": "Whether this overlay is active",
            "default": true
          },
          "updateInterval": {
            "type": "integer",
            "description": "How often to update this overlay in milliseconds",
            "default": 1000,
            "minimum": 100
          },
          "format": {
            "type": "object",
            "description": "Formatting options (varies by overlay type)"
          },
          "style": {
            "type": "object",
            "description": "Manual style overrides",
            "properties": {
              "fontSize": {"type": "integer"},
              "fontFamily": {"type": "string"},
              "color": {"type": "string"},
              "fontWeight": {"type": "string"},
              "textAlign": {"type": "string"},
              "letterSpacing": {"type": "string"}
            }
          },
          "text": {
            "type": "string",
            "description": "Static text content (for type: 'text')"
          },
          "comment": {
            "type": "string",
            "description": "Optional comment explaining this overlay"
          },
          "region": {
            "type": "object",
            "description": "Overlay region (use tools/detect-overlays.js to generate)",
            "required": ["x", "y", "width", "height"],
            "properties": {
              "x": {"type": "integer"},
              "y": {"type": "integer"},
              "width": {"type": "integer"},
              "height": {"type": "integer"}
            }
          },
          "detectedStyle": {
            "type": "object",
            "description": "Overlay style detected from page (use tools/detect-overlays.js to generate)",
            "required": ["fontSize", "fontFamily", "color"],
            "properties": {
              "fontSize": {"type": "integer"},
              "fontFamily": {"type": "string"},
              "color": {"type": "string"},
              "fontWeight": {"type": "string"},
              "textAlign": {"type": "string"},
              "letterSpacing": {"type": "string"}
            }
          }
        }
      }
    },
    "changeDetection": {
      "type": "object",
      "description": "Configuration for detecting page changes",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable automatic change detection",
          "default": true
        },
        "watchSelectors": {
          "type": "array",
          "description": "CSS selectors to watch for changes",
          "items": {"type": "string"},
          "default": ["img", "[style*='background']"]
        },
        "watchAttributes": {
          "type": "array",
          "description": "HTML attributes to watch for changes",
          "items": {"type": "string"},
          "default": ["src", "style", "class", "srcset"]
        },
        "periodicCheckInterval": {
          "type": "integer",
          "description": "Fallback periodic check interval in milliseconds",
          "default": 120000,
          "minimum": 1000
        },
        "debounceDelay": {
          "type": "integer",
          "description": "Delay before triggering re-render after change detected",
          "default": 500,
          "minimum": 0
        },
        "comment": {
          "type": "string"
        }
      }
    },
    "performance": {
      "type": "object",
      "description": "Performance optimization settings",
      "properties": {
        "scrollToLoadLazy": {
          "type": "boolean",
          "description": "Scroll page to trigger lazy-loaded images",
          "default": true
        },
        "waitForImages": {
          "type": "boolean",
          "description": "Wait for all images to load before rendering",
          "default": true
        },
        "bufferPooling": {
          "type": "boolean",
          "description": "Enable buffer pooling to reduce GC pressure",
          "default": true
        },
        "splashScreen": {
          "type": "string",
          "description": "Path to splash screen image to show during startup"
        }
      }
    },
    "perfMonitoring": {
      "type": "object",
      "description": "Performance monitoring and profiling configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable performance monitoring",
          "default": false
        },
        "verbose": {
          "type": "boolean",
          "description": "Enable verbose logging of all operations",
          "default": false
        },
        "logToFile": {
          "type": "string",
          "description": "Path to performance log file (optional)"
        },
        "reportInterval": {
          "type": "integer",
          "description": "Milliseconds between periodic performance reports (0 = disabled)",
          "default": 0,
          "minimum": 0
        },
        "trackMemory": {
          "type": "boolean",
          "description": "Track memory usage for each operation",
          "default": true
        }
      }
    },
    "stressManagement": {
      "type": "object",
      "description": "System stress detection and recovery management for resource-constrained hardware",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable stress monitoring and throttling",
          "default": true
        },
        "thresholds": {
          "type": "object",
          "description": "Performance thresholds that trigger stress detection",
          "properties": {
            "overlayUpdateWarning": {
              "type": "integer",
              "description": "Milliseconds - warn if overlay update exceeds this duration",
              "default": 3000,
              "minimum": 100
            },
            "overlayUpdateCritical": {
              "type": "integer",
              "description": "Milliseconds - critical if overlay update exceeds this duration",
              "default": 10000,
              "minimum": 100
            },
            "baseImageWarning": {
              "type": "integer",
              "description": "Milliseconds - warn if base image recapture exceeds this duration",
              "default": 5000,
              "minimum": 100
            },
            "baseImageCritical": {
              "type": "integer",
              "description": "Milliseconds - critical if base image recapture exceeds this duration",
              "default": 15000,
              "minimum": 100
            }
          }
        },
        "recovery": {
          "type": "object",
          "description": "Recovery behavior configuration",
          "properties": {
            "skipUpdatesOnStress": {
              "type": "boolean",
              "description": "Skip queued invisible operations when system is stressed",
              "default": true
            },
            "maxConsecutiveSlowOps": {
              "type": "integer",
              "description": "Number of consecutive slow operations before entering moderate stress",
              "default": 3,
              "minimum": 1
            },
            "cooldownPeriod": {
              "type": "integer",
              "description": "Milliseconds to wait after killing browser before restart",
              "default": 30000,
              "minimum": 1000
            },
            "killBrowserThreshold": {
              "type": "integer",
              "description": "Number of critical events before killing browser",
              "default": 3,
              "minimum": 1
            },
            "recoveryCheckInterval": {
              "type": "integer",
              "description": "Milliseconds between stress level checks",
              "default": 5000,
              "minimum": 1000
            },
            "profileSizeThresholdMB": {
              "type": "integer",
              "description": "Megabytes - restart browser if Chrome profile exceeds this size (important for tmpfs/RAM)",
              "default": 40,
              "minimum": 1
            }
          }
        },
        "comment": {
          "type": "string",
          "description": "Optional comment about stress management configuration"
        }
      }
    }
  }
}
